@model IEnumerable<ShopDoCu.Models.Cart>
@{
    ViewData["Title"] = "Giỏ hàng";
}

<style>
    .cart-item-row { transition: background-color 0.2s; }
    .cart-item-row:hover { background-color: #f8f9fa; }
    .quantity-input { max-width: 60px; text-align: center; border: none; background: #f1f3f5; font-weight: 600; }
</style>

<div class="container my-5">
    <div class="d-flex align-items-center mb-4">
        <h3 class="fw-bold text-dark m-0">Giỏ hàng</h3>
        <span class="badge bg-primary rounded-pill ms-2">@Model.Count() sản phẩm</span>
    </div>

    @if (Model != null && Model.Any())
    {
        <form id="cartForm" asp-action="Checkout" asp-controller="Order" method="get">
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                        <div class="table-responsive">
                            <table class="table align-middle mb-0">
                                <thead class="bg-light text-secondary text-uppercase small fw-bold">
                                    <tr>
                                        <th class="ps-4 py-3" style="width: 50px;">
                                            <input class="form-check-input" type="checkbox" id="selectAll" style="transform: scale(1.2); cursor: pointer;">
                                        </th>
                                        <th class="py-3">Sản phẩm</th>
                                        <th class="text-center">Đơn giá</th>
                                        <th class="text-center">Số lượng</th>
                                        <th class="text-end pe-4">Thành tiền</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model)
                                    {
                                        var product = item.Product;
                                        var img = product?.ProductImages?.FirstOrDefault(x => x.IsMain== true)?.ImageUrl ?? "/images/no-image.jpg";
                                        decimal price = product?.Price ?? 0;
                                        int qty = item.Quantity ?? 1;
                                        decimal total = price * qty;

                                        <tr class="cart-item-row border-bottom">
                                            <td class="ps-4">
                                                <input type="checkbox" name="selectedIds" value="@item.CartId" class="form-check-input selectItem" style="transform: scale(1.2); cursor: pointer;">
                                            </td>
                                            <td class="py-3">
                                                <div class="d-flex align-items-center">
                                                    <img src="@img" class="rounded-3 border" style="width: 70px; height: 70px; object-fit: cover;">
                                                    <div class="ms-3">
                                                        <a href="/Product/Details/@item.ProductId" class="fw-bold text-dark text-decoration-none d-block">@product?.ProductName</a>
                                                        <small class="text-muted">Kho: @product?.Quantity</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="text-center fw-medium">@price.ToString("N0")₫</td>
                                            <td class="text-center">
                                                <input type="number" value="@qty" min="1" class="quantity-input rounded" onchange="updateQuantity(this, @item.ProductId)" />
                                            </td>
                                            <td class="text-end fw-bold text-primary pe-4 item-total-price">@total.ToString("N0")₫</td>
                                            <td class="text-center pe-3">
                                                <a href="/Cart/Remove?productId=@item.ProductId" class="btn btn-sm btn-light text-danger rounded-circle" onclick="return confirm('Xóa?')"><i class="bi bi-trash"></i></a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card border-0 shadow rounded-4 p-4 sticky-top" style="top: 20px;">
                        <h5 class="fw-bold mb-4">Thanh toán</h5>
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-muted">Đã chọn:</span>
                            <span class="fw-bold" id="countSelected">0 sản phẩm</span>
                        </div>
                        <div class="d-flex justify-content-between mb-4 align-items-center">
                            <span class="text-muted">Tổng tiền:</span>
                            <span class="fs-4 fw-bold text-danger" id="selectedTotal">0₫</span>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm" id="btnCheckout" disabled>
                            THANH TOÁN <i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    }
    else
    {
        <div class="text-center py-5"><h4 class="text-muted">Giỏ hàng trống</h4><a href="/" class="btn btn-primary mt-3">Mua sắm ngay</a></div>
    }
</div>

@section Scripts {
    <script>
        function updateSelectedTotal() {
            let total = 0;
            let count = 0;
            $('.selectItem:checked').each(function() {
                count++;
                let row = $(this).closest('tr');
                let priceText = row.find('.item-total-price').text().replace(/\D/g, '');
                total += parseInt(priceText) || 0;
            });
            
            $('#selectedTotal').text(total.toLocaleString('vi-VN') + '₫');
            $('#countSelected').text(count + ' sản phẩm');
            $('#btnCheckout').prop('disabled', count === 0);
        }

        $(document).on('change', '#selectAll, .selectItem', function() {
            if (this.id === 'selectAll') $('.selectItem').prop('checked', this.checked);
            else if (!this.checked) $('#selectAll').prop('checked', false);
            updateSelectedTotal();
        });

        function updateQuantity(input, productId) {
            let qty = $(input).val();
            if (qty < 1) { qty = 1; $(input).val(1); }
            
            $.post('/Cart/UpdateCart', { productId: productId, quantity: qty }, function(res) {
                if(res.success) {
                    // Load lại trang để cập nhật giá tiền chuẩn từ server
                    window.location.reload(); 
                } else {
                    alert(res.message);
                }
            });
        }
        
        $(document).ready(function() { updateSelectedTotal(); });
    </script>
}