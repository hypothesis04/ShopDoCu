@model ShopDoCu.Models.User
@{
    ViewData["Title"] = "Thanh toán";
    var cartItems = ViewBag.CartItems as List<ShopDoCu.Models.Cart>;
    var totalAmount = (decimal)ViewBag.TotalAmount;
    var myCoupons = ViewBag.UserCoupons as List<ShopDoCu.Models.UserCoupon>;
    
    // Logic ràng buộc 20 triệu
    bool isOverLimit = totalAmount > 20000000;
}

<style>
    .payment-option-label { cursor: pointer; transition: 0.2s; border: 2px solid transparent; }
    .payment-option-input:checked + .payment-option-label { border-color: #0d6efd; background-color: #f0f7ff; }
    .payment-disabled { opacity: 0.5; pointer-events: none; background-color: #f8f9fa; }
</style>

<div class="container my-5">
    <div class="text-center mb-5">
        <h2 class="fw-bold text-primary">Xác nhận đơn hàng</h2>
    </div>

    <form asp-action="Checkout" method="post" id="checkoutForm">
        @foreach(var item in cartItems) { <input type="hidden" name="selectedIds" value="@item.CartId" /> }

        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-white py-3"><h5 class="fw-bold m-0">Thông tin nhận hàng</h5></div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-secondary">Họ tên người nhận</label>
                                <input type="text" name="receiverName" class="form-control" value="@(Model.FullName ?? Model.UserName)" required placeholder="Nhập họ tên...">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-secondary">Số điện thoại</label>
                                <input type="text" name="receiverPhone" class="form-control" value="@Model.Phone" required placeholder="Nhập số điện thoại...">
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold small text-secondary">Địa chỉ giao hàng</label>
                                <input type="text" name="shippingAddress" class="form-control" value="@Model.Address" required placeholder="Số nhà, đường, phường, quận...">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-header bg-white py-3"><h5 class="fw-bold m-0">Thanh toán</h5></div>
                    <div class="card-body p-4">
                        
                        @if (isOverLimit)
                        {
                            <div class="alert alert-warning border-0 shadow-sm d-flex align-items-center mb-4">
                                <i class="bi bi-exclamation-triangle-fill fs-3 me-3 text-warning"></i>
                                <div>
                                    <strong class="text-dark">Lưu ý quan trọng:</strong><br>
                                    Đơn hàng của bạn trên <strong>20.000.000₫</strong>. Theo quy định, bạn bắt buộc phải thanh toán bằng <strong>Chuyển khoản</strong>.
                                </div>
                            </div>
                        }

                        <div class="row g-3">
                            <div class="col-md-6">
                                <input class="form-check-input d-none payment-option-input" type="radio" name="paymentMethod" id="cod" value="COD" 
                                       @(isOverLimit ? "disabled" : "checked")>
                                
                                <label class="payment-option-label card p-3 h-100 shadow-sm rounded-3 @(isOverLimit ? "payment-disabled" : "")" for="cod">
                                    <div class="fw-bold text-success"><i class="bi bi-cash-coin me-2"></i>Tiền mặt (COD)</div>
                                    @if(isOverLimit) { <small class="text-danger d-block mt-1">(Không khả dụng)</small> }
                                </label>
                            </div>

                            <div class="col-md-6">
                                <input class="form-check-input d-none payment-option-input" type="radio" name="paymentMethod" id="online" value="Online"
                                       @(isOverLimit ? "checked" : "")>
                                
                                <label class="payment-option-label card p-3 h-100 shadow-sm rounded-3" for="online">
                                    <div class="fw-bold text-primary"><i class="bi bi-bank me-2"></i>Chuyển khoản</div>
                                </label>
                            </div>
                        </div>
                        
                         <div id="onlineBox" class="mt-4 p-4 bg-primary bg-opacity-10 rounded-4 text-center border border-primary border-dashed" style="display: none;">
                            <h6 class="fw-bold text-primary mb-3">Quét mã QR để thanh toán</h6>
                            <div class="bg-white p-2 d-inline-block rounded shadow-sm">
                                <i class="bi bi-qr-code-scan" style="font-size: 5rem; color: #333;"></i>
                            </div>
                            <div class="mt-3 small text-muted">
                                Nội dung CK: <strong class="text-dark">[Tên] - [SĐT]</strong>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card border-0 shadow rounded-4 sticky-top" style="top: 20px;">
                    <div class="card-header bg-light py-3"><h5 class="fw-bold m-0">Đơn hàng</h5></div>
                    <div class="card-body p-0">
                        <div class="overflow-auto" style="max-height: 250px;">
                            @foreach (var item in cartItems)
                            {
                                <div class="d-flex justify-content-between p-3 border-bottom">
                                    <span>@item.Product.ProductName <span class="badge bg-secondary rounded-pill ms-1">x @item.Quantity</span></span>
                                    <span class="fw-bold">@((item.Product.Price * item.Quantity)?.ToString("N0"))₫</span>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="p-4 bg-light">
                        <label class="fw-bold mb-2 small text-uppercase text-muted">Mã giảm giá</label>
                        <select id="couponSelect" name="selectedCouponId" class="form-select border-0 shadow-sm" onchange="updateCheckoutTotal()">
                            <option value="" data-discount="0">-- Chọn mã ưu đãi --</option>
                            @if (myCoupons != null)
                            {
                                foreach (var coupon in myCoupons)
                                {
                                    <option value="@coupon.UserCouponId" data-discount="@coupon.DiscountAmount">
                                        @coupon.Code (-@coupon.DiscountAmount.ToString("N0")₫)
                                    </option>
                                }
                            }
                        </select>
                    </div>

                    <div class="card-footer bg-white p-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Tạm tính</span>
                            <span class="fw-bold">@totalAmount.ToString("N0")₫</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3 text-success" id="discountRow" style="display: none;">
                            <span>Ưu đãi</span>
                            <span class="fw-bold" id="discountValue">-0₫</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-4 border-top pt-3">
                            <span class="h5 fw-bold m-0">Tổng cộng</span>
                            <span class="h3 fw-bold text-danger m-0" id="finalTotal">@totalAmount.ToString("N0")₫</span>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow">ĐẶT HÀNG</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        var originalTotal = @totalAmount;
        function updateCheckoutTotal() {
            var discount = $('#couponSelect option:selected').data('discount') || 0;
            var finalTotal = originalTotal - discount;
            if(finalTotal < 0) finalTotal = 0;

            if (discount > 0) {
                $('#discountRow').show();
                $('#discountValue').text('-' + parseInt(discount).toLocaleString('vi-VN') + '₫');
            } else {
                $('#discountRow').hide();
            }
            $('#finalTotal').text(finalTotal.toLocaleString('vi-VN') + '₫');
        }

        $(document).ready(function() {
            function toggleOnlineBox() {
                if ($('#online').is(':checked')) {
                    $('#onlineBox').slideDown();
                } else {
                    $('#onlineBox').slideUp();
                }
            }
            $('input[name="paymentMethod"]').change(toggleOnlineBox);
            toggleOnlineBox(); // Chạy ngay khi load
        });
    </script>
}