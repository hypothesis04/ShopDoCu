@model ProductCreateViewModel
@{
    ViewData["Title"] = "Đăng bán sản phẩm";
}

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-megaphone me-2"></i>Đăng bán sản phẩm mới</h4>
                </div>
                <div class="card-body p-4">

                    @* --- PHẦN 1: THÔNG BÁO THÀNH CÔNG --- *@
                    @if (ViewBag.IsSuccess == true)
                    {
                        <div class="text-center my-5">
                            <div class="mb-3">
                                <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
                            </div>
                            <h3 class="text-success fw-bold">Đăng tin thành công!</h3>
                            <p class="lead text-muted">Sản phẩm đã gửi lên hệ thống và đang chờ duyệt.</p>
                            
                            <div class="mt-4 d-flex justify-content-center gap-3">
                                <a href="/Product/Create" class="btn btn-outline-primary">
                                    <i class="bi bi-plus-lg me-1"></i>Đăng bài khác
                                </a>
                                <a href="/" class="btn btn-primary">
                                    <i class="bi bi-house-door me-1"></i>Về Trang chủ
                                </a>
                            </div>
                        </div>
                    }
                    else
                    {
                        @* --- PHẦN 2: FORM NHẬP LIỆU --- *@
                        <div class="alert alert-info mb-4">
                            <i class="bi bi-info-circle me-2"></i>
                            Điền đầy đủ thông tin để sản phẩm tiếp cận khách hàng tốt nhất.
                        </div>

                        <form asp-action="Create" method="post" enctype="multipart/form-data" id="productForm">
                            @Html.AntiForgeryToken()
                            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                            <div class="row g-3">
                                <div class="col-12">
                                    <label asp-for="ProductName" class="form-label fw-bold">Tên sản phẩm <span class="text-danger">*</span></label>
                                    <input asp-for="ProductName" class="form-control" placeholder="VD: Laptop Dell XPS 15" />
                                    <span asp-validation-for="ProductName" class="text-danger small"></span>
                                </div>

                                <div class="col-12">
                                    <label asp-for="Description" class="form-label fw-bold">Mô tả</label>
                                    <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                                    <span asp-validation-for="Description" class="text-danger small"></span>
                                </div>

                                <div class="col-md-6">
                                    <label asp-for="Price" class="form-label fw-bold">Giá bán</label>
                                    <div class="input-group">
                                        <input asp-for="Price" type="number" class="form-control" placeholder="0" />
                                        <span class="input-group-text">VNĐ</span>
                                    </div>
                                    <span asp-validation-for="Price" class="text-danger small"></span>
                                </div>

                                <div class="col-md-6">
                                    <label asp-for="Quantity" class="form-label fw-bold">Số lượng</label>
                                    <input asp-for="Quantity" type="number" class="form-control" value="1" />
                                </div>

                              <div class="col-md-6">
                                    <label class="form-label fw-bold">Tình trạng</label>
                                    <div class="d-flex align-items-center border rounded px-3 py-2 bg-white" style="height: 48px;">
                                        <div class="form-check form-switch mb-0">
                                            <input class="form-check-input" type="checkbox" role="switch" asp-for="IsNew" id="isNewSwitch" style="cursor: pointer; transform: scale(1.2); margin-right: 10px;">
                                            
                                            <label class="form-check-label user-select-none" for="isNewSwitch" style="cursor: pointer;">
                                                Đây là <b>Hàng mới</b> (New)
                                            </label>
                                        </div>
                                    </div>
                                    <small class="text-muted ms-1"><i class="bi bi-info-circle me-1"></i>Mặc định không tích là <b>Đồ cũ</b>.</small>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="Location" class="form-label fw-bold">Khu vực</label>
                                    <input asp-for="Location" class="form-control" />
                                    <span asp-validation-for="Location" class="text-danger small"></span>
                                </div>

                                <div class="col-md-6">
                                    <label asp-for="ParentCategoryId" class="form-label fw-bold">Danh mục chính</label>
                                    <select asp-for="ParentCategoryId" asp-items="ViewBag.ParentCategories" class="form-select" id="parentCategory">
                                        <option value="">-- Chọn danh mục --</option>
                                    </select>
                                    <span asp-validation-for="ParentCategoryId" class="text-danger small"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="CategoryId" class="form-label fw-bold">Chi tiết</label>
                                    <select asp-for="CategoryId" class="form-select" id="childCategory" disabled>
                                        <option value="">-- Chọn danh mục cha trước --</option>
                                    </select>
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-bold">Hình ảnh (Tối thiểu 3)</label>
                                    <input type="file" name="ProductImages" class="form-control" multiple accept="image/*" id="imageInput" />
                                    <div id="imagePreview" class="row g-2 mt-3"></div>
                                </div>

                                <div class="col-12">
                                    <label asp-for="MainImageIndex" class="form-label fw-bold">Ảnh đại diện</label>
                                    <select asp-for="MainImageIndex" class="form-select" id="mainImageSelect" disabled>
                                        <option value="">-- Tải ảnh lên trước --</option>
                                    </select>
                                </div>
                            </div>

                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-primary btn-lg shadow-sm">
                                    <i class="bi bi-send-fill me-2"></i>Gửi tin đăng bán
                                </button>
                                <a href="/" class="btn btn-outline-secondary">Hủy bỏ</a>
                            </div>
                        </form>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        $(document).ready(function() {
            // 1. CHẶN GỬI NHIỀU LẦN
            $('#productForm').on('submit', function() {
                if ($(this).valid()) {
                    var btn = $(this).find('button[type="submit"]');
                    btn.prop('disabled', true);
                    btn.html('<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...');
                }
            });

            // 2. LOAD DANH MỤC CON
            $('#parentCategory').on('change', function() {
                const parentId = $(this).val();
                const childSelect = $('#childCategory');
                
                childSelect.html('<option value="">-- Đang tải... --</option>').prop('disabled', true);

                if (parentId) {
                    $.getJSON(`/Product/GetChildCategories?parentId=${parentId}`, function(data) {
                        childSelect.empty().append('<option value="">-- Chọn danh mục con --</option>');
                        if (data.length > 0) {
                            $.each(data, function(i, item) {
                                childSelect.append($('<option>').val(item.categoryId).text(item.categoryName));
                            });
                            childSelect.prop('disabled', false);
                        } else {
                            childSelect.html('<option value="">-- Không có mục con --</option>');
                        }
                    }).fail(function() {
                        childSelect.html('<option value="">-- Lỗi tải dữ liệu --</option>');
                    });
                } else {
                    childSelect.html('<option value="">-- Chọn danh mục cha trước --</option>');
                }
            });

            // 3. PREVIEW ẢNH
            $('#imageInput').on('change', function(e) {
                const files = e.target.files;
                const preview = $('#imagePreview');
                const mainSelect = $('#mainImageSelect');
                
                preview.empty();
                mainSelect.empty().append('<option value="">-- Chọn ảnh chính --</option>').prop('disabled', true);
                
                if (files.length < 3) {
                    preview.html('<div class="col-12"><div class="alert alert-warning py-1 small">Vui lòng chọn tối thiểu 3 ảnh.</div></div>');
                    return;
                }
                
                mainSelect.prop('disabled', false);

                Array.from(files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const html = `
                            <div class="col-4 col-md-3">
                                <div class="card border">
                                    <img src="${event.target.result}" class="card-img-top" style="height: 100px; object-fit: cover;">
                                    <div class="card-footer p-1 text-center small bg-light">Ảnh ${index + 1}</div>
                                </div>
                            </div>`;
                        preview.append(html);
                    };
                    reader.readAsDataURL(file);
                    mainSelect.append(`<option value="${index}">Ảnh ${index + 1}</option>`);
                });
                mainSelect.val(0);
            });
            $('#statusSwitch').on('change', function() {
                var label = $('#statusLabel');
                if ($(this).is(':checked')) {
                    // Nếu đang bật -> Là hàng mới
                    label.html('<i class="bi bi-stars text-warning me-1"></i><span class="text-success">Hàng mới (Chưa bóc tem)</span>');
                    $(this).parent().parent().removeClass('bg-light').addClass('border-success bg-success-subtle');
                } else {
                    // Nếu đang tắt -> Là đồ cũ
                    label.html('<i class="bi bi-recycle text-secondary me-1"></i><span class="text-dark">Đồ cũ (Đã qua sử dụng)</span>');
                    $(this).parent().parent().addClass('bg-light').removeClass('border-success bg-success-subtle');
                }
            });
        });
    </script>
}