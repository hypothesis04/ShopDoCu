@model ShopDoCu.Models.Product
@using Microsoft.AspNetCore.Http
@using Newtonsoft.Json
@inject IHttpContextAccessor HttpContextAccessor
@{
    ViewData["Title"] = Model.ProductName;
    Layout = "~/Views/Shared/_Layout.cshtml";

    var mainImage = Model.ProductImages.FirstOrDefault(i => i.IsMain == true)?.ImageUrl
                    ?? Model.ProductImages.FirstOrDefault()?.ImageUrl
                    ?? "/images/no-image.png";

    var currentUserId = HttpContextAccessor.HttpContext?.Session?.GetInt32("UserId");
    var isSeller = (currentUserId != null && Model.SellerId == currentUserId);
    
    // Lấy biến quyền đánh giá từ Controller
    bool canReview = ViewBag.CanReview != null && (bool)ViewBag.CanReview;

    // Logic kiểm tra người bán bị khoá 
    bool isSellerRevoked = false;
    if (Model.Seller != null)
    {
        bool isDemoted = (Model.Seller.Role != "Seller" && Model.Seller.Role != "Admin");
        bool isLocked = (Model.Seller.IsLocked == true || Model.Seller.Role == "OldSeller");
        if (isDemoted || isLocked) { isSellerRevoked = true; }
    }
}

<style>
    /* CSS cho phần chọn sao */
    .rating-stars i { cursor: pointer; color: #ddd; font-size: 1.5rem; transition: color 0.2s; }
    .rating-stars i.active { color: #ffc107; } /* Màu vàng */
    .rating-stars i:hover { color: #ffdb58; }
</style>

<div class="container py-5">
    <div class="row mb-5">
        <div class="col-lg-5 mb-4">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-2">
                    <div class="main-image-container mb-3 text-center border rounded bg-white" style="height: 400px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        <img id="mainProductImage" src="@mainImage" class="img-fluid" style="max-height: 100%; object-fit: contain;" alt="Ảnh chính">
                    </div>
                    @if (Model.ProductImages.Count > 1)
                    {
                        <div class="d-flex gap-2 overflow-auto py-2 px-1 custom-scrollbar">
                            @foreach (var img in Model.ProductImages)
                            {
                                <img src="@img.ImageUrl" class="rounded border thumbnail-img" style="width: 80px; height: 80px; object-fit: cover; cursor: pointer; opacity: 0.7;" onclick="changeImage(this.src)">
                            }
                        </div>
                    }
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-header bg-white py-3 border-bottom">
                    <h6 class="fw-bold m-0"><i class="bi bi-star-fill text-warning me-2"></i>Đánh giá sản phẩm</h6>
                </div>
                <div class="card-body p-3">
                    <div class="text-center py-4 bg-light rounded-3 mb-3">
                        <p class="text-muted small mb-0">Chưa có bình luận nào.</p>
                    </div>
                    @if (canReview)
                    {
                        <form asp-action="AddReview" asp-controller="Product" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="productId" value="@Model.ProductId" />
                            <input type="hidden" name="rating" id="ratingValue" value="5" />

                            <div class="mb-2 text-center">
                                <label class="fw-bold small mb-1 d-block">Chọn số sao:</label>
                                <div class="rating-stars" id="starContainer">
                                    <i class="bi bi-star-fill active" data-value="1"></i>
                                    <i class="bi bi-star-fill active" data-value="2"></i>
                                    <i class="bi bi-star-fill active" data-value="3"></i>
                                    <i class="bi bi-star-fill active" data-value="4"></i>
                                    <i class="bi bi-star-fill active" data-value="5"></i>
                                </div>
                                <div class="small text-warning fw-bold mt-1" id="ratingText">Tuyệt vời (5/5)</div>
                            </div>

                            <textarea name="comment" class="form-control form-control-sm mb-2" rows="2" placeholder="Sản phẩm thế nào?..." required></textarea>
                            
                            <div class="mb-2">
                                <label class="form-label small fw-bold mb-1"><i class="bi bi-camera-fill me-1"></i>Thêm ảnh (tùy chọn):</label>
                                <input type="file" name="reviewImage" class="form-control form-control-sm" accept="image/*">
                            </div>

                            <button type="submit" class="btn btn-primary btn-sm w-100 rounded-pill">Gửi đánh giá</button>
                        </form>
                    }
                    else if (currentUserId != null)
                    {
                         <div class="alert alert-secondary small text-center m-0 p-2">
                            <i class="bi bi-lock-fill me-1"></i>Bạn phải mua sản phẩm này mới được đánh giá.
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body">
                    <h2 class="fw-bold text-dark mb-2">@Model.ProductName</h2>

                    <div class="mb-4">
                        <span class="h3 text-danger fw-bold me-3">@Model.Price.ToString("N0") VNĐ</span>
                        <span class="badge @(Model.IsNew == true ? "bg-success" : "bg-warning text-dark")">
                            @(Model.IsNew == true ? "Hàng mới" : "Đồ cũ")
                        </span>
                    </div>

                    <p class="text-muted mb-4" style="white-space: pre-line;">@(Model.Description ?? "Không có mô tả.")</p>

                    @if (!string.IsNullOrEmpty(Model.Specifications))
                    {
                        var specs = new List<dynamic>();
                        try { specs = Newtonsoft.Json.JsonConvert.DeserializeObject<List<dynamic>>(Model.Specifications); } catch { }
                        if (specs.Any())
                        {
                            <h5 class="mt-4">Thông số kỹ thuật</h5>
                            <table class="table table-bordered table-striped mb-4">
                                <tbody>
                                    @foreach (var spec in specs) { <tr><td>@spec.Key</td><td>@spec.Value</td></tr> }
                                </tbody>
                            </table>
                        }
                    }

                    <div class="d-flex align-items-center mb-4 p-3 bg-light rounded">
                        <img src="@(Model.Seller?.AvatarUrl ?? "/images/default-avatar.png")" class="rounded-circle border me-3" style="width: 50px; height: 50px; object-fit: cover;">
                        <div>
                            <small class="text-muted">Người bán</small>
                            <h6 class="mb-0 fw-bold">@(Model.Seller?.StoreName ?? Model.Seller?.UserName)</h6>
                            <small><i class="bi bi-geo-alt-fill text-danger"></i> @(Model.Location ?? "Toàn quốc")</small>
                        </div>
                    </div>

                    @if (Model.Status == "Active" && (Model.Quantity > 0))
                    {
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Số lượng:</label>
                                <div class="input-group">
                                    <button class="btn btn-outline-secondary" type="button" onclick="stepDown()" @(isSeller ? "disabled" : "")>-</button>
                                    <input type="number" id="quantityInput" class="form-control text-center" value="1" min="1" max="@Model.Quantity" @(isSeller ? "disabled" : "")>
                                    <button class="btn btn-outline-secondary" type="button" onclick="stepUp()" @(isSeller ? "disabled" : "")>+</button>
                                </div>
                                <small class="text-muted">Có sẵn: @Model.Quantity</small>
                            </div>

                            <div class="col-md-8">
                                @if (isSeller) {
                                    <a href="/SellerChannel/EditProduct/@Model.ProductId" class="btn btn-outline-primary w-100">Sửa sản phẩm</a>
                                } else if (isSellerRevoked) {
                                    <button disabled class="btn btn-danger w-100">Shop bị khóa</button>
                                } else {
                                    <button type="button" onclick="addToCartAjax(@Model.ProductId)" class="btn btn-primary btn-lg w-100 shadow-sm" style="height: 48px;">
                                        <i class="bi bi-cart-plus me-2"></i>Thêm vào giỏ
                                    </button>
                                }
                            </div>
                        </div>

                        <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
                        <div id="cartToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex">
                            <div class="toast-body">
                                <i class="bi bi-check-circle-fill me-2"></i>Đã thêm vào giỏ thành công!
                                <a href="/Cart" class="text-white fw-bold text-decoration-underline ms-2">Xem giỏ</a>
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                            </div>
                        </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-danger mt-3"><i class="bi bi-exclamation-circle me-2"></i>Hết hàng hoặc ngừng kinh doanh.</div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="mt-5 mb-5">
        <h4 class="fw-bold text-uppercase border-start border-4 border-primary ps-3 mb-4">Sản phẩm liên quan</h4>
        <div class="row g-3">
            @if (ViewBag.RelatedProducts != null) {
                foreach (var item in (List<ShopDoCu.Models.Product>)ViewBag.RelatedProducts) {
                    var img = item.ProductImages?.FirstOrDefault(x => x.IsMain == true)?.ImageUrl ?? item.ProductImages?.FirstOrDefault()?.ImageUrl ?? "/images/no-image.jpg";
                    <div class="col-6 col-md-3">
                        <div class="card h-100 border-0 shadow-sm product-card-hover">
                            <a href="/Product/Details/@item.ProductId">
                                <div style="height: 200px; display: flex; align-items: center; justify-content: center; background: #fff;">
                                    <img src="@img" class="card-img-top p-2" style="max-height: 100%; width: auto; object-fit: contain;">
                                </div>
                            </a>
                            <div class="card-body p-3 pt-2">
                                <h6 class="card-title text-truncate mb-2"><a href="/Product/Details/@item.ProductId" class="text-decoration-none text-dark fw-bold">@item.ProductName</a></h6>
                                <span class="text-danger fw-bold">@item.Price.ToString("N0")₫</span>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

<style>
    .product-card-hover { transition: transform 0.2s; }
    .product-card-hover:hover { transform: translateY(-5px); }
</style>

@section Scripts {
    <script>
        function changeImage(src) { document.getElementById('mainProductImage').src = src; }
        function stepUp() { var i = document.getElementById('quantityInput'); if(parseInt(i.value) < parseInt(i.getAttribute('max'))) i.value = parseInt(i.value)+1; }
        function stepDown() { var i = document.getElementById('quantityInput'); if(parseInt(i.value) > 1) i.value = parseInt(i.value)-1; }

        // --- SCRIPT XỬ LÝ CHỌN SAO ---
        $(document).ready(function() {
            $('.rating-stars i').hover(
                function() { // Mouse over
                    var val = $(this).data('value');
                    updateStarsVisual(val);
                }, 
                function() { // Mouse out
                    var currentVal = $('#ratingValue').val();
                    updateStarsVisual(currentVal);
                }
            );

            $('.rating-stars i').click(function() {
                var val = $(this).data('value');
                $('#ratingValue').val(val);
                updateStarsVisual(val);
                
                // Cập nhật chữ hiển thị
                var text = "";
                if(val == 1) text = "Tệ (1/5)";
                else if(val == 2) text = "Trung bình (2/5)";
                else if(val == 3) text = "Khá (3/5)";
                else if(val == 4) text = "Tốt (4/5)";
                else text = "Tuyệt vời (5/5)";
                $('#ratingText').text(text);
            });

            function updateStarsVisual(value) {
                $('.rating-stars i').each(function() {
                    if ($(this).data('value') <= value) {
                        $(this).addClass('active').removeClass('bi-star').addClass('bi-star-fill');
                    } else {
                        $(this).removeClass('active').removeClass('bi-star-fill').addClass('bi-star');
                    }
                });
            }
        });
        function addToCartAjax(pid) {
        var qty = $('#quantityInput').val();
        $.post('/Cart/AddToCartApi', { productId: pid, quantity: qty }, function(res) {
            if (res.success) {
                // 1. Cập nhật số trên menu (nếu có class badge-cart)
                $('.badge-cart').text(res.cartCount).show();
                // 2. Hiện thông báo góc phải
                var toast = new bootstrap.Toast(document.getElementById('cartToast'));
                toast.show();
            } else {
                if (res.requireLogin) window.location.href = "/Account/Login"; // Chưa đăng nhập -> Chuyển trang
                else alert(res.message); // Lỗi khác -> Báo lỗi
            }
        }).fail(function() { alert('Lỗi kết nối!'); });
        }
    </script>
}