@model ShopDoCu.Models.Product

@{
    ViewData["Title"] = "Chỉnh sửa sản phẩm";
    // Lấy ID danh mục cha được truyền từ Controller (nếu có)
    var selectedParentId = ViewBag.SelectedParentId as int?;
}

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Chỉnh sửa sản phẩm</h4>
                </div>
                <div class="card-body p-4">

                    <div class="alert alert-warning mb-4 d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                        <div>
                            <strong>Lưu ý quan trọng:</strong><br />
                            Sau khi bạn lưu thay đổi, sản phẩm sẽ chuyển sang trạng thái 
                            <span class="badge bg-secondary">Pending</span> (Chờ duyệt) 
                            và sẽ tạm ẩn khỏi trang chủ cho đến khi Admin duyệt lại.
                        </div>
                    </div>

                    <form asp-action="Edit" method="post" enctype="multipart/form-data" id="editProductForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="ProductId" />
                        
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <div class="row g-3">
                            <div class="col-12">
                                <label asp-for="ProductName" class="form-label fw-bold">Tên sản phẩm <span class="text-danger">*</span></label>
                                <input asp-for="ProductName" class="form-control" placeholder="Nhập tên sản phẩm..." required />
                                <span asp-validation-for="ProductName" class="text-danger small"></span>
                            </div>

                            <div class="col-12">
                                <label asp-for="Description" class="form-label fw-bold">Mô tả chi tiết</label>
                                <textarea asp-for="Description" class="form-control" rows="5"></textarea>
                                <span asp-validation-for="Description" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Price" class="form-label fw-bold">Giá bán</label>
                                <div class="input-group">
                                    <input asp-for="Price" type="number" class="form-control" min="0" required />
                                    <span class="input-group-text">VNĐ</span>
                                </div>
                                <span asp-validation-for="Price" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Quantity" class="form-label fw-bold">Số lượng trong kho</label>
                                <input asp-for="Quantity" type="number" class="form-control" min="1" required />
                                <span asp-validation-for="Quantity" class="text-danger small"></span>
                            </div>

                          <div class="col-md-6">
                            <label class="form-label fw-bold">Tình trạng</label>
                            <div class="d-flex align-items-center border rounded px-3 py-2 bg-white" style="height: 48px;">
                                <div class="form-check form-switch mb-0">
                                    <input class="form-check-input" 
                                        type="checkbox" 
                                        role="switch" 
                                        name="IsNew" 
                                        value="true" 
                                        id="isNewSwitch" 
                                        @(Model.IsNew == true ? "checked" : "")
                                        style="cursor: pointer; transform: scale(1.2); margin-right: 10px;">
                                    
                                    <label class="form-check-label user-select-none" for="isNewSwitch" style="cursor: pointer;">
                                        Đây là <b>Hàng mới</b> (New)
                                    </label>
                                    
                                    <input type="hidden" name="IsNew" value="false" />
                                </div>
                            </div>
                            <small class="text-muted ms-1">Mặc định không tích là <b>Đồ cũ</b>.</small>
                        </div>

                            <div class="col-md-6">
                                <label asp-for="Location" class="form-label fw-bold">Khu vực bán</label>
                                <input asp-for="Location" class="form-control" placeholder="VD: TP.HCM, Hà Nội..." />
                                <span asp-validation-for="Location" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Danh mục chính</label>
                                <select name="ParentCategoryId" class="form-select" id="parentCategory">
                                    <option value="">-- Chọn danh mục --</option>
                                    @if (ViewBag.ParentCategories != null)
                                    {
                                        foreach (var item in (SelectList)ViewBag.ParentCategories)
                                        {
                                            // Kiểm tra nếu item này trùng với selectedParentId thì chọn nó
                                            if (selectedParentId.ToString() == item.Value)
                                            {
                                                <option value="@item.Value" selected>@item.Text</option>
                                            }
                                            else
                                            {
                                                <option value="@item.Value">@item.Text</option>
                                            }
                                        }
                                    }
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="CategoryId" class="form-label fw-bold">Chi tiết danh mục</label>
                                <select asp-for="CategoryId" class="form-select" id="childCategory" asp-items="ViewBag.ChildCategories">
                                    @if (ViewBag.ChildCategories == null)
                                    {
                                        <option value="">-- Chọn danh mục cha trước --</option>
                                    }
                                </select>
                                <span asp-validation-for="CategoryId" class="text-danger small"></span>
                            </div>

                            <div class="col-12 mt-4">
                                <label class="form-label fw-bold">Hình ảnh sản phẩm</label>
                                
                                <div class="mb-3">
                                    <p class="small text-muted mb-2">Ảnh hiện tại đang sử dụng:</p>
                                    <div class="d-flex gap-2 overflow-auto pb-2">
                                        @if (Model.ProductImages != null && Model.ProductImages.Any())
                                        {
                                            foreach (var img in Model.ProductImages)
                                            {
                                                <div class="position-relative border rounded p-1" style="width: 100px; height: 100px;">
                                                    <img src="@img.ImageUrl" class="w-100 h-100 object-fit-cover rounded" />
                                                    @if (img.IsMain == true)
                                                    {
                                                        <span class="badge bg-primary position-absolute top-0 start-0 m-1">Ảnh bìa</span>
                                                    }
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted fst-italic">Chưa có ảnh nào.</span>
                                        }
                                    </div>
                                </div>

                                <div class="p-3 bg-light border rounded border-dashed">
                                    <label class="form-label fw-bold text-primary">
                                        <i class="bi bi-cloud-upload me-2"></i>Tải lên ảnh mới (Để thay thế ảnh cũ)
                                    </label>
                                    <input type="file" name="newImages" class="form-control" multiple accept="image/*" id="imageInput" />
                                    <div class="form-text text-danger mt-1">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Lưu ý: Nếu bạn chọn ảnh mới, <strong>toàn bộ ảnh cũ sẽ bị xóa</strong> và thay thế bằng ảnh mới này.
                                    </div>
                                    <div id="imagePreview" class="row g-2 mt-3"></div>
                                    <div class="mt-3">
                                        <label class="form-label fw-bold">Chọn ảnh đại diện (Cho bộ ảnh mới)</label>
                                        <select name="MainImageIndex" class="form-select" id="mainImageSelect" disabled>
                                            <option value="0">-- Vui lòng tải ảnh lên trước --</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-5 border-top pt-3">
                            <a href="/Product/Details/@Model.ProductId" class="btn btn-secondary">Hủy bỏ</a>
                            <button type="submit" class="btn btn-primary fw-bold px-4">
                                <i class="bi bi-save me-2"></i>Lưu thay đổi
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}