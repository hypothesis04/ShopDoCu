@model ShopDoCu.Models.Product
@{
    ViewData["Title"] = "Sửa sản phẩm";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var selectedParentId = ViewBag.SelectedParentId as int?;
}

<div class="container my-4">
    <div class="row">
        <div class="col-12" id="edit-product-container">

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning text-dark py-3">
                    <h5 class="fw-bold mb-0"><i class="bi bi-pencil-square me-2"></i>Chỉnh sửa sản phẩm</h5>
                </div>
                <div class="card-body p-4">
                    
                    <div class="alert alert-warning small mb-3">
                        <i class="bi bi-info-circle me-1"></i>
                        Lưu ý: Sau khi sửa, sản phẩm sẽ chuyển về trạng thái <b>Chờ duyệt (Pending)</b>.
                    </div>

                    <form asp-action="EditProduct" asp-controller="SellerChannel" method="post" enctype="multipart/form-data" id="edit-product-form">
                        <input type="hidden" asp-for="ProductId" />

                        <div class="mb-3">
                            <label class="form-label fw-bold">Tên sản phẩm</label>
                            <input asp-for="ProductName" class="form-control" required />
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Danh mục chính</label>
                                <select name="ParentCategoryId" class="form-select" id="parentCategory">
                                    <option value="">-- Chọn danh mục --</option>
                                    @if (ViewBag.ParentCategories != null) {
                                        foreach (var item in (SelectList)ViewBag.ParentCategories) {
                                            if (selectedParentId.ToString() == item.Value) {
                                                <option value="@item.Value" selected>@item.Text</option>
                                            } else {
                                                <option value="@item.Value">@item.Text</option>
                                            }
                                        }
                                    }
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Danh mục con</label>
                                <select asp-for="CategoryId" class="form-select" id="childCategory" asp-items="ViewBag.ChildCategories">
                                     @if (ViewBag.ChildCategories == null) { <option value="">-- Chọn cha trước --</option> }
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Giá bán</label>
                                <input asp-for="Price" type="number" class="form-control" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Kho</label>
                                <input asp-for="Quantity" type="number" class="form-control" required />
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Khu vực bán</label>
                                <input asp-for="Location" class="form-control" />
                            </div>
                             <div class="col-md-6">
                                <label class="form-label fw-bold">Tình trạng</label>
                                <div class="form-check form-switch border rounded p-2">
                                   <input class="form-check-input ms-0 me-2" 
                                        type="checkbox" 
                                        name="IsNew" 
                                        value="true" 
                                        id="IsNew"
                                        @(Model.IsNew == true ? "checked" : "") 
                                        style="transform: scale(1.2);">
                                    <label class="form-check-label">Hàng mới (New)</label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Mô tả</label>
                            <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                        </div>

                        <div class="mb-4 bg-light p-3 rounded border border-dashed">
                            <label class="form-label fw-bold">Thông số kỹ thuật</label>
                            <div id="specifications-list"></div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addSpecRow()">
                                <i class="bi bi-plus"></i> Thêm dòng
                            </button>
                            <input type="hidden" asp-for="Specifications" id="specifications-json" />
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Cập nhật hình ảnh (Sẽ thay thế ảnh cũ)</label>
                            <div class="border border-dashed rounded p-3 text-center bg-light">
                                <input type="file" name="newImages" class="form-control mb-3" multiple accept="image/*" id="imageInput" />
                                <div id="imagePreview" class="row g-2">
                                    @if (Model.ProductImages != null)
                                    {
                                        <p class="text-muted small w-100 mb-2">Ảnh hiện tại:</p>
                                        foreach(var img in Model.ProductImages)
                                        {
                                            <div class="col-3"><img src="@img.ImageUrl" class="img-thumbnail" style="height: 80px; object-fit: contain;"></div>
                                        }
                                    }
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <label class="form-label fw-bold">Chọn ảnh đại diện (Cho ảnh mới tải lên)</label>
                                <select name="MainImageIndex" id="mainImageSelect" class="form-select">
                                    <option value="0">-- Mặc định ảnh đầu tiên --</option>
                                </select>
                            </div>
                        </div>

                        <div id="form-error-msg" class="alert alert-danger d-none"></div>

                        <div class="text-end border-top pt-3">
                            <a href="/SellerChannel/MyProducts" class="btn btn-secondary">Hủy</a>
                            <button type="submit" class="btn btn-warning fw-bold px-4"><i class="bi bi-save me-1"></i> Lưu thay đổi</button>
                        </div>
                    </form>
                </div>
        </div>
    </div>
    </div>
</div>

@section Scripts {
    <script>

        function addSpecRow(key = '', value = '') {
            $('#specifications-list').append(`
                <div class='input-group mb-2 spec-row'>
                    <input type='text' class='form-control form-control-sm' placeholder='Tên' value='${key}' />
                    <input type='text' class='form-control form-control-sm' placeholder='Giá trị' value='${value}' />
                    <button type='button' class='btn btn-outline-danger btn-sm' onclick="$(this).parent().remove()"><i class='bi bi-x'></i></button>
                </div>
            `);
        }

        $(document).ready(function() {
            var json = $('#specifications-json').val();
            if (json) {
                try {
                    JSON.parse(json).forEach(s => addSpecRow(s.Key, s.Value));
                } catch(e) {}
            }
        });
    </script>
}